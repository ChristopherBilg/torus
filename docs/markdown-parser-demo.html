<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Markdown Parser demo annotated source</title>
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <main>
        <div class="line">
            <div class="doc">
                <h1>Markdown Parser demo <span class="fade">annotated source</span></h1>
                <em><a class="back" href="./">Back to index</a></em>
            </div>
            <pre></pre>
        </div>
        <div class="line"><div class="doc"><p>A renderer for a custom flavor of markdown, that renders live, with every keystroke. I wrote the <code>Marked</code> component to be integrated into my productivity apps (I&#39;m rewriting my notes and todo apps soon), but it also works well as a live editor by itself.</p>
</div><pre class="source javascript"><strong class="lineNumber">6</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Bootstrap the required globals from Torus, since we&#39;re not bundling</p>
</div><pre class="source javascript"><strong class="lineNumber">8</strong>for (const exportedName in Torus) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">9</strong>    window[exportedName] = Torus[exportedName];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">10</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">11</strong></pre></div>
<div class="line"><div class="doc"><p>Like <code>jdom.js</code>, this is a unique object that identifies that a reader has reached the last character/line to read. Used for parsing strings.</p>
</div><pre class="source javascript"><strong class="lineNumber">15</strong>const READER_END = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>These are the regular expressions (<code>RE</code>) that match things like headers, images, and quotes.</p>
</div><pre class="source javascript"><strong class="lineNumber">18</strong>const RE_HEADER = /^(#{1,6})\s*(.*)/;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">19</strong>const RE_IMAGE = /^%\s+(\S*)/;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">20</strong>const RE_QUOTE = /^(&#62;+)\s*(.*)/;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">21</strong>const RE_LIST_ITEM = /^(\s*)(-|\d+\.)\s+(.*)/;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">22</strong></pre></div>
<div class="line"><div class="doc"><p>Delimiters for text styles. If you want the more standard flavor of markdown, you can change these these delimiters to get 90% of the way there (minus the links).</p>
</div><pre class="source javascript"><strong class="lineNumber">27</strong>const ITALIC_DELIMITER = '/';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">28</strong>const BOLD_DELIMITER = '*';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">29</strong>const STRIKE_DELIMITER = '~';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">30</strong>const CODE_DELIMITER = '`';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">31</strong>const LINK_DELIMITER_LEFT = '&#60;';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">32</strong>const LINK_DELIMITER_RIGHT = '&#62;';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">33</strong>const PRE_DELIMITER = '``';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">34</strong>const LITERAL_DELIMITER = '%%';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">35</strong></pre></div>
<div class="line"><div class="doc"><p>Some text expansions / replacements I find convenient.</p>
</div><pre class="source javascript"><strong class="lineNumber">37</strong>const BODY_TEXT_TRANSFORMS = new Map([</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">38</strong>    // RegExp: replacement</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">39</strong>    [/--/g, '‚Äî'], // em-dash from two dashes</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">40</strong>    [/(\?!|!\?)/g, '‚ÄΩ'], // interrobang!</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">41</strong>    [/\$\$/g, 'üíµ'],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">42</strong>    [/:\)/g, 'üôÇ'],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">43</strong>    [/&#60;3/g, '‚ù§Ô∏è'],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">44</strong>    [/:wave:/g, 'üëã'],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">45</strong>]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">46</strong></pre></div>
<div class="line"><div class="doc"><p>This is the default input that the user sees when they first open the app. It demonstrates the basic syntax.</p>
</div><pre class="source javascript"><strong class="lineNumber">49</strong>const INPUT_PLACEHOLDER = `# Write some markdown!</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">50</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">51</strong>## Hash signs mark /headers/.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">52</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">53</strong>Here's some text, with /italics/, *bold*, ~strikethrough~, and \`monospace\` styles. We can also *~/combine/~* these things for */\`more emphasis\`/*.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">54</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">55</strong>Let's include some links. Here's one to &#60;https://google.com/&#62;.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">56</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">57</strong>&#62; Quotes.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">58</strong>&#62;&#62; Nested quotes, like this...</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">59</strong>&#62;&#62; ... even across lines.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">60</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">61</strong>We can include lists ...</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">62</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">63</strong>- First</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">64</strong>- Second</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">65</strong>    - Third, which is indented</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">66</strong>    - Fourth</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">67</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">68</strong>We can also number lists, and mix both styles.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">69</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">70</strong>1. Cal Bears</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">71</strong>2. Purdue Boilermakers</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">72</strong>3. every other school</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">73</strong>    - ???</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">74</strong>4. Stanford... trees?</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">75</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">76</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">77</strong>We can include code blocks.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">78</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">79</strong>\`\`</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">80</strong>#include &#60;stdio.h&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">81</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">82</strong>int main() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">83</strong>    printf("Two backticks denote a code block");</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">84</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">85</strong>    return 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">86</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">87</strong>\`\`</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">88</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">89</strong>To include images, prefix the URL with a percent sign:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">90</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">91</strong>% https://www.ocf.berkeley.edu/~linuslee/pic.jpg</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">92</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">93</strong>That's it! Happy markdowning :)</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">94</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">95</strong>If you're curious about how this app works, you can check out the entire, annotated source code at &#60;https://thesephist.github.io/torus/markdown-parser-demo&#62;, where you'll find annotated JavaScript source files behind this and a few other apps.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">96</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">97</strong>This renderer was built with Torus, a UI framework for the web written by Linus, for his personal suite of productivity apps. You can find more information about Torus at &#60;https://github.com/thesephist/torus/&#62;, and you can find Linus at &#60;https://linus.zone/now/&#62;.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">98</strong>`;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">99</strong></pre></div>
<div class="line"><div class="doc"><p>A generator that yields characters from a string, used for parsing text.</p>
</div><pre class="source javascript"><strong class="lineNumber">101</strong>class Reader {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">102</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">103</strong>    constructor(str) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">104</strong>        this.str = str;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">105</strong>        this.idx = 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">106</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">107</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">108</strong>    next() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">109</strong>        return this.str[this.idx ++] || READER_END;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">110</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">111</strong></pre></div>
<div class="line"><div class="doc"><p>Look ahead a character, but don&#39;t increment the position.</p>
</div><pre class="source javascript"><strong class="lineNumber">113</strong>    ahead() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">114</strong>        return this.str[this.idx] || READER_END;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">115</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">116</strong></pre></div>
<div class="line"><div class="doc"><p>Reads the string until the first occurrence of a given character.</p>
</div><pre class="source javascript"><strong class="lineNumber">118</strong>    until(char) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">119</strong>        const sub = this.str.substr(this.idx);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">120</strong>        const nextIdx = sub.indexOf(char);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">121</strong>        const part = sub.substr(char, nextIdx);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">122</strong>        this.idx += nextIdx + 1;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">123</strong>        return part;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">124</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">125</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">126</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">127</strong></pre></div>
<div class="line"><div class="doc"><p>Like <code>Reader</code>, but for lines. It&#39;s used for things like parsing nested lists and block quotes.</p>
</div><pre class="source javascript"><strong class="lineNumber">130</strong>class LineReader {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">131</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">132</strong>    constructor(lines) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">133</strong>        this.lines = lines;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">134</strong>        this.idx = 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">135</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">136</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">137</strong>    next() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">138</strong>        if (this.idx &#60; this.lines.length) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">139</strong>            return this.lines[this.idx ++];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">140</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">141</strong>            this.idx = this.lines.length;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">142</strong>            return READER_END;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">143</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">144</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">145</strong></pre></div>
<div class="line"><div class="doc"><p>Decrement the counter, so <code>next()</code> will return the same line once again.</p>
</div><pre class="source javascript"><strong class="lineNumber">147</strong>    backtrack() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">148</strong>        this.idx = this.idx - 1 &#60; 0 ? 0 : this.idx - 1;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">149</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">150</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">151</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">152</strong></pre></div>
<div class="line"><div class="doc"><p>Parse &quot;body text&quot;, which may include italics, bold text, strikethroughs, and inline code blocks. This also takes care of text expansions defined above.</p>
</div><pre class="source javascript"><strong class="lineNumber">155</strong>const parseBody = (reader, tag, delimiter = '') =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">156</strong>    const children = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">157</strong>    let buf = '';</pre></div>
<div class="line"><div class="doc"><p>Function to &quot;commit&quot; the text read into the buffer as a child of body text, so we can add other elements after it.</p>
</div><pre class="source javascript"><strong class="lineNumber">160</strong>    const commitBuf = () =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">161</strong>        for (const re of BODY_TEXT_TRANSFORMS.keys()) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">162</strong>            buf = buf.replace(re, BODY_TEXT_TRANSFORMS.get(re));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">163</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">164</strong>        children.push(buf);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">165</strong>        buf = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">166</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">167</strong>    let char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">168</strong>    let last = '';</pre></div>
<div class="line"><div class="doc"><p>Loop through each character. If there are delimiters, read until the end of the delimited chunk of text and parse the contents inside as the right tag.</p>
</div><pre class="source javascript"><strong class="lineNumber">172</strong>    while (last = char, char = reader.next()) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">173</strong>        switch (char) {</pre></div>
<div class="line"><div class="doc"><p>Backslash is an escape character, so anything that comes right after it is just read into the buffer.</p>
</div><pre class="source javascript"><strong class="lineNumber">176</strong>            case '\\':</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">177</strong>                buf += reader.next();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">178</strong>                break;</pre></div>
<div class="line"><div class="doc"><p>If we find the delimiter <code>parseBody</code> was called with, that means we&#39;ve reached the end of the delimited sequence of text we were reading from <code>reader</code> and must return control flow to the calling function.</p>
</div><pre class="source javascript"><strong class="lineNumber">182</strong>            case delimiter:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">183</strong>                if (last === ' ') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">184</strong>                    buf += char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">185</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">186</strong>                    commitBuf();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">187</strong>                    return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">188</strong>                        tag: tag,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">189</strong>                        children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">190</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">191</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">192</strong>                break;</pre></div>
<div class="line"><div class="doc"><p>If we reach the end of the body text, commit everything we&#39;ve got so far and return the whole thing.</p>
</div><pre class="source javascript"><strong class="lineNumber">195</strong>            case READER_END:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">196</strong>                commitBuf();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">197</strong>                return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">198</strong>                    tag: tag,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">199</strong>                    children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">200</strong>                }</pre></div>
<div class="line"><div class="doc"><p>Each of these delimiter cases check if the next character is a space. If it is, it may just be that the user is trying to type, e.g. 3 &lt; 10 or async / await. We don&#39;t count those characters as styling delimiters. That would be annoying for the user.</p>
</div><pre class="source javascript"><strong class="lineNumber">205</strong>            case ITALIC_DELIMITER:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">206</strong>                if (reader.ahead() === ' ') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">207</strong>                    buf += char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">208</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">209</strong>                    commitBuf();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">210</strong>                    children.push(parseBody(reader, 'em', ITALIC_DELIMITER));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">211</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">212</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">213</strong>            case BOLD_DELIMITER:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">214</strong>                if (reader.ahead() === ' ') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">215</strong>                    buf += char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">216</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">217</strong>                    commitBuf();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">218</strong>                    children.push(parseBody(reader, 'strong', BOLD_DELIMITER));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">219</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">220</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">221</strong>            case STRIKE_DELIMITER:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">222</strong>                if (reader.ahead() === ' ') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">223</strong>                    buf += char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">224</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">225</strong>                    commitBuf();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">226</strong>                    children.push(parseBody(reader, 'strike', STRIKE_DELIMITER));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">227</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">228</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">229</strong>            case CODE_DELIMITER:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">230</strong>                if (reader.ahead() === ' ') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">231</strong>                    buf += char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">232</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">233</strong>                    commitBuf();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">234</strong>                    children.push({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">235</strong>                        tag: 'code',</pre></div>
<div class="line"><div class="doc"><p>Rather than recursively parsing the text inside a code block, we just take it verbatim. Otherwise symbols like * and / in code have to be escaped, which would be really annoying.</p>
</div><pre class="source javascript"><strong class="lineNumber">239</strong>                        children: [reader.until(CODE_DELIMITER)],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">240</strong>                    });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">241</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">242</strong>                break;</pre></div>
<div class="line"><div class="doc"><p>If we find a link, we read until the end of the link and return a JDOM object that&#39;s a clickable link tag that opens in another tab.</p>
</div><pre class="source javascript"><strong class="lineNumber">245</strong>            case LINK_DELIMITER_LEFT:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">246</strong>                if (reader.ahead() === ' ') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">247</strong>                    buf += char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">248</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">249</strong>                    commitBuf();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">250</strong>                    const url = reader.until(LINK_DELIMITER_RIGHT);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">251</strong>                    children.push({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">252</strong>                        tag: 'a',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">253</strong>                        attrs: {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">254</strong>                            href: url || '#',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">255</strong>                            rel: 'noopener',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">256</strong>                            target: '_blank',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">257</strong>                        },</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">258</strong>                        children: [url],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">259</strong>                    });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">260</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">261</strong>                break;</pre></div>
<div class="line"><div class="doc"><p>If none of the special cases matched, just add the character to the buffer we&#39;re reading to.</p>
</div><pre class="source javascript"><strong class="lineNumber">264</strong>            default:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">265</strong>                buf += char;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">266</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">267</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">268</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">269</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">270</strong>    throw new Error('This should not happen while reading body text!');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">271</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">272</strong></pre></div>
<div class="line"><div class="doc"><p>Given a reader of lines, parse (potentially) nested lists recursively.</p>
</div><pre class="source javascript"><strong class="lineNumber">274</strong>const parseList = lineReader =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">275</strong>    const children = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">276</strong></pre></div>
<div class="line"><div class="doc"><p>We check out the first line in the sequence to determine how far indented we are, and what kind of list (number, bullet) it is.</p>
</div><pre class="source javascript"><strong class="lineNumber">280</strong>    let line = lineReader.next();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">281</strong>    const [_, indent, prefix] = RE_LIST_ITEM.exec(line);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">282</strong>    const tag = prefix === '-' ? 'ul' : 'ol';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">283</strong>    const indentLevel = indent.length;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">284</strong>    lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">285</strong></pre></div>
<div class="line"><div class="doc"><p>Loop through the next few lines from the reader.</p>
</div><pre class="source javascript"><strong class="lineNumber">287</strong>    while ((line = lineReader.next()) !== READER_END) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">288</strong>        const [_, _indent, prefix] = RE_LIST_ITEM.exec(line) || [];</pre></div>
<div class="line"><div class="doc"><p>If there&#39;s a valid list item prefix, we count it as a list item.</p>
</div><pre class="source javascript"><strong class="lineNumber">290</strong>        if (prefix) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>We compare the indentation level of this line, versus the first line in the list.</p>
</div><pre class="source javascript"><strong class="lineNumber">293</strong>            const thisIndentLevel = line.indexOf(prefix);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>If it&#39;s indented less, we&#39;ve stumbled upon the end of the list section. Backtrack and return control to the parent list or block.</p>
</div><pre class="source javascript"><strong class="lineNumber">297</strong>            if (thisIndentLevel &#60; indentLevel) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">298</strong>                lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">299</strong>                return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">300</strong>                    tag: tag,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">301</strong>                    children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">302</strong>                }</pre></div>
<div class="line"><div class="doc"><p>If it&#39;s the same indentation, treat it as the next item in the list. Parse the list content as body text, and add it to the list of children.</p>
</div><pre class="source javascript"><strong class="lineNumber">305</strong>            } else if (thisIndentLevel === indentLevel) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">306</strong>                const body = line.match(/\s*(?:\d+\.|-)\s*(.*)/)[1];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">307</strong>                children.push(parseBody(new Reader(body), 'li'));</pre></div>
<div class="line"><div class="doc"><p>If this line is indented farther than the first line, that means it&#39;s the start of a further-nested list. Call <code>parseList</code> recursively, and add the returned list as a child.</p>
</div><pre class="source javascript"><strong class="lineNumber">312</strong>            } else { // thisIndentLevel &#62; indentLevel</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">313</strong>                lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">314</strong>                children.push(parseList(lineReader));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">315</strong>            }</pre></div>
<div class="line"><div class="doc"><p>If there&#39;s no valid list item prefix, it&#39;s the end of the list.</p>
</div><pre class="source javascript"><strong class="lineNumber">317</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">318</strong>            lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">319</strong>            return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">320</strong>                tag: tag,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">321</strong>                children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">322</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">323</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">324</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">325</strong>    return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">326</strong>        tag: tag,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">327</strong>        children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">328</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">329</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">330</strong></pre></div>
<div class="line"><div class="doc"><p>Like <code>parseList</code>, but for nested block quotes.</p>
</div><pre class="source javascript"><strong class="lineNumber">332</strong>const parseQuote = lineReader =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">333</strong>    const children = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">334</strong></pre></div>
<div class="line"><div class="doc"><p>Look ahead at the first line to determine how far nested we are.</p>
</div><pre class="source javascript"><strong class="lineNumber">336</strong>    let line = lineReader.next();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">337</strong>    const [_, nestCount] = RE_QUOTE.exec(line);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">338</strong>    const nestLevel = nestCount.length;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">339</strong>    lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">340</strong></pre></div>
<div class="line"><div class="doc"><p>Loop through each line in the block quote.</p>
</div><pre class="source javascript"><strong class="lineNumber">342</strong>    while ((line = lineReader.next()) !== READER_END) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">343</strong>        const [_, nestCount, quoteText] = RE_QUOTE.exec(line) || [];</pre></div>
<div class="line"><div class="doc"><p>If we&#39;re able to find a line matching the block quote regex, count it as another line in the block.</p>
</div><pre class="source javascript"><strong class="lineNumber">346</strong>        if (quoteText !== undefined) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">347</strong>            const thisNestLevel = nestCount.length;</pre></div>
<div class="line"><div class="doc"><p>If this line is nested less than the first line, it&#39;s the end of this block quote. Return control to the parent block quote.</p>
</div><pre class="source javascript"><strong class="lineNumber">351</strong>            if (thisNestLevel &#60; nestLevel) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">352</strong>                lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">353</strong>                return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">354</strong>                    tag: 'q',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">355</strong>                    children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">356</strong>                }</pre></div>
<div class="line"><div class="doc"><p>If this line is indented same as the first line, continue reading the quote.</p>
</div><pre class="source javascript"><strong class="lineNumber">359</strong>            } else if (thisNestLevel === nestLevel) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">360</strong>                children.push(parseBody(new Reader(quoteText), 'p'));</pre></div>
<div class="line"><div class="doc"><p>If this line is indented further in, it&#39;s the start of another nested quote block. Call itself recursively.</p>
</div><pre class="source javascript"><strong class="lineNumber">363</strong>            } else { // thisNestLevel &#62; nestLevel</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">364</strong>                lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">365</strong>                children.push(parseQuote(lineReader));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">366</strong>            }</pre></div>
<div class="line"><div class="doc"><p>If the line didn&#39;t match the block quote regex, it&#39;s the end of the block quote, so return what we have.</p>
</div><pre class="source javascript"><strong class="lineNumber">369</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">370</strong>            lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">371</strong>            return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">372</strong>                tag: 'q',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">373</strong>                children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">374</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">375</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">376</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">377</strong>    return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">378</strong>        tag: 'q',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">379</strong>        children: children,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">380</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">381</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">382</strong></pre></div>
<div class="line"><div class="doc"><p>Main Torus function component for the parser. This component takes a string input, parses it into JDOM (HTML elements), and returns it in a <code>&lt;div&gt;</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">386</strong>const Markus = str =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">387</strong></pre></div>
<div class="line"><div class="doc"><p>Make a new line reader that we&#39;ll pass to functions to read the input.</p>
</div><pre class="source javascript"><strong class="lineNumber">389</strong>    const lineReader = new LineReader(str.split('\n'));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">390</strong></pre></div>
<div class="line"><div class="doc"><p>Various parsing state registers.</p>
</div><pre class="source javascript"><strong class="lineNumber">392</strong>    let inCodeBlock = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">393</strong>    let codeBlockResult = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">394</strong>    let inLiteralBlock = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">395</strong>    let literalBlockResult = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">396</strong>    const result = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">397</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">398</strong>    let line;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">399</strong>    while ((line = lineReader.next()) !== READER_END) {</pre></div>
<div class="line"><div class="doc"><p>If we&#39;re in a code block, don&#39;t do more parsing and add the line directly to the code block</p>
</div><pre class="source javascript"><strong class="lineNumber">402</strong>        if (inCodeBlock) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">403</strong>            if (line === PRE_DELIMITER) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">404</strong>                result.push({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">405</strong>                    tag: 'pre',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">406</strong>                    children: [codeBlockResult],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">407</strong>                });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">408</strong>                inCodeBlock = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">409</strong>                codeBlockResult = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">410</strong>            } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">411</strong>                if (!codeBlockResult) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">412</strong>                    codeBlockResult = line.trimStart() + '\n';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">413</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">414</strong>                    codeBlockResult += line + '\n';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">415</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">416</strong>            }</pre></div>
<div class="line"><div class="doc"><p>... likewise for literal HTML blocks.</p>
</div><pre class="source javascript"><strong class="lineNumber">418</strong>        } else if (inLiteralBlock) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">419</strong>            if (line === LITERAL_DELIMITER) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">420</strong>                const wrapper = document.createElement('div');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">421</strong>                wrapper.innerHTML = literalBlockResult;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">422</strong>                result.push(wrapper);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">423</strong>                inLiteralBlock = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">424</strong>                literalBlockResult = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">425</strong>            } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">426</strong>                literalBlockResult += line;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">427</strong>            }</pre></div>
<div class="line"><div class="doc"><p>If the line starts with a hash sign, it&#39;s a header! Parse it as such.</p>
</div><pre class="source javascript"><strong class="lineNumber">429</strong>        } else if (line.startsWith('#')) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">430</strong>            const [_, hashes, header] = RE_HEADER.exec(line);</pre></div>
<div class="line"><div class="doc"><p>The HTML tag is <code>&#39;h&#39;</code> followed by the number of <code>#</code> signs.</p>
</div><pre class="source javascript"><strong class="lineNumber">432</strong>            result.push(parseBody(new Reader(header), 'h' + hashes.length));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>If the line matches the image line format, parse the URL out of the line and add a link that wraps the image, so it&#39;s clickable in the final result HTML.</p>
</div><pre class="source javascript"><strong class="lineNumber">436</strong>        } else if (RE_IMAGE.exec(line)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">437</strong>            const [_, imageURL] = RE_IMAGE.exec(line);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">438</strong>            result.push({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">439</strong>                tag: 'a',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">440</strong>                attrs: {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">441</strong>                    href: imageURL || '#',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">442</strong>                    rel: 'noopener',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">443</strong>                    target: '_blank',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">444</strong>                    style: {cursor: 'pointer'},</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">445</strong>                },</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">446</strong>                children: [{</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">447</strong>                    tag: 'img',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">448</strong>                    attrs: {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">449</strong>                        src: imageURL,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">450</strong>                        style: {maxWidth: '100%'},</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">451</strong>                    },</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">452</strong>                }],</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">453</strong>            });</pre></div>
<div class="line"><div class="doc"><p>If the line matches a block quote format, backtrack and send the control off to the block quote parser, including the line we just read.</p>
</div><pre class="source javascript"><strong class="lineNumber">457</strong>        } else if (RE_QUOTE.exec(line)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">458</strong>            lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">459</strong>            result.push(parseQuote(lineReader));</pre></div>
<div class="line"><div class="doc"><p>Detect horizontal dividers and handle it.</p>
</div><pre class="source javascript"><strong class="lineNumber">461</strong>        } else if (line === '- -') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">462</strong>            result.push({tag: 'hr'});</pre></div>
<div class="line"><div class="doc"><p>Detect start of a code block</p>
</div><pre class="source javascript"><strong class="lineNumber">464</strong>        } else if (line === PRE_DELIMITER) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">465</strong>            inCodeBlock = true;</pre></div>
<div class="line"><div class="doc"><p>Detect start of a literal HTML block</p>
</div><pre class="source javascript"><strong class="lineNumber">467</strong>        } else if (line === LITERAL_DELIMITER) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">468</strong>            inLiteralBlock = true;</pre></div>
<div class="line"><div class="doc"><p>Detect list formats (numbered, bullet) and if they&#39;re found, send the control flow off to the list parsing function.</p>
</div><pre class="source javascript"><strong class="lineNumber">472</strong>        } else if (RE_LIST_ITEM.exec(line)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">473</strong>            lineReader.backtrack();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">474</strong>            result.push(parseList(lineReader));</pre></div>
<div class="line"><div class="doc"><p>If none of the above match, it&#39;s a plain old boring paragraph. Read the line as a paragraph body.</p>
</div><pre class="source javascript"><strong class="lineNumber">477</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">478</strong>            result.push(parseBody(new Reader(line), 'p'));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">479</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">480</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">481</strong></pre></div>
<div class="line"><div class="doc"><p>Return the array of children wrapped in a <code>&lt;div&gt;</code>, with some padding at the bottom so it&#39;s freely scrollable during editing.</p>
</div><pre class="source javascript"><strong class="lineNumber">484</strong>    return jdom`&#60;div class="render" style="padding-bottom:75vh"&#62;${result}&#60;/div&#62;`;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">485</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">486</strong></pre></div>
<div class="line"><div class="doc"><p>Editor view modes</p>
</div><pre class="source javascript"><strong class="lineNumber">488</strong>const MODE = {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>0 -&gt; two-up, preview and editor; default</p>
</div><pre class="source javascript"><strong class="lineNumber">490</strong>    BOTH: 0,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>1 -&gt; editor only</p>
</div><pre class="source javascript"><strong class="lineNumber">492</strong>    EDITOR: 1,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>2 -&gt; preview only</p>
</div><pre class="source javascript"><strong class="lineNumber">494</strong>    PREVIEW: 2,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">495</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">496</strong></pre></div>
<div class="line"><div class="doc"><p>The app component wraps the entire application and handles state.</p>
</div><pre class="source javascript"><strong class="lineNumber">498</strong>class App extends StyledComponent {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">499</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">500</strong>    init() {</pre></div>
<div class="line"><div class="doc"><p>We start with the default two-up view</p>
</div><pre class="source javascript"><strong class="lineNumber">502</strong>        this.mode = MODE.BOTH;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Temporary state used to store whether the save button should show the saving state indicator (&quot;saved&quot;)</p>
</div><pre class="source javascript"><strong class="lineNumber">505</strong>        this.showSavedIndicator = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">506</strong></pre></div>
<div class="line"><div class="doc"><p>If we&#39;ve previously saved the user input, pull that back out. Otherwise, use the default placeholder.</p>
</div><pre class="source javascript"><strong class="lineNumber">509</strong>        this.inputValue = window.localStorage.getItem('markusInput') || INPUT_PLACEHOLDER;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">510</strong></pre></div>
<div class="line"><div class="doc"><p>Bind a few methods we&#39;re using to handle input.</p>
</div><pre class="source javascript"><strong class="lineNumber">512</strong>        this.handleInput = this.handleInput.bind(this);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">513</strong>        this.handleKeydown = this.handleKeydown.bind(this);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">514</strong>        this.handleToggleMode = this.handleToggleMode.bind(this);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">515</strong>        this.handleSave = this.save.bind(this, {showIndicator: true});</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">516</strong></pre></div>
<div class="line"><div class="doc"><p>Before the user leaves the site, we want to save the user input to local storage so we can pull it back out later when the user visits the site again.</p>
</div><pre class="source javascript"><strong class="lineNumber">519</strong>        window.addEventListener('beforeunload',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">520</strong>            this.save.bind(this, {showIndicator: false}));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">521</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">522</strong></pre></div>
<div class="line"><div class="doc"><p>Callback to save current editor buffer contents to <code>localStorage</code>. This method takes an option to give feedback to the user, which is set to false if saving on the onbeforeunload event.</p>
</div><pre class="source javascript"><strong class="lineNumber">526</strong>    save({showIndicator} = {}) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">527</strong>        if (showIndicator) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">528</strong>            this.showSavedIndicator = true;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">529</strong>            setTimeout(() =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">530</strong>                this.showSavedIndicator = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">531</strong>                this.render();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">532</strong>            }, 1000);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">533</strong>            this.render();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">534</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">535</strong>        window.localStorage.setItem('markusInput', this.inputValue);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">536</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">537</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">538</strong>    styles() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">539</strong>        return css`</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">540</strong>        box-sizing: border-box;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">541</strong>        font-family: system-ui, sans-serif;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">542</strong>        display: flex;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">543</strong>        flex-direction: column;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">544</strong>        justify-content: space-between;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">545</strong>        align-items: flex-start;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">546</strong>        height: 100vh;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">547</strong>        width: 100%;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">548</strong>        max-width: 1600px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">549</strong>        margin: 0 auto;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">550</strong>        overflow: hidden;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">551</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">552</strong>        header {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">553</strong>            padding: 20px 18px 0 18px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">554</strong>            box-sizing: border-box;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">555</strong>            width: 100%;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">556</strong>            display: flex;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">557</strong>            flex-direction: row;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">558</strong>            align-items: center;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">559</strong>            justify-content: space-between;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">560</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">561</strong>        .buttonGroup {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">562</strong>            display: flex;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">563</strong>            flex-direction: row;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">564</strong>            align-items: center;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">565</strong>            justify-content: space-between;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">566</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">567</strong>            button {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">568</strong>                margin: 0 6px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">569</strong>                padding: 6px 10px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">570</strong>                font-size: 1em;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">571</strong>                border-radius: 4px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">572</strong>                background: #fff;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">573</strong>                box-shadow: 0 3px 8px -1px rgba(0, 0, 0, .3);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">574</strong>                border: 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">575</strong>                cursor: pointer;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">576</strong>                &#38;:hover {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">577</strong>                    opacity: .7;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">578</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">579</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">580</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">581</strong>        .title {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">582</strong>            margin: 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">583</strong>            font-weight: normal;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">584</strong>            color: #888;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">585</strong>            .dark {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">586</strong>                color: #000;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">587</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">588</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">589</strong>        .renderContainer {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">590</strong>            display: flex;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">591</strong>            flex-direction: row;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">592</strong>            justify-content: space-between;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">593</strong>            align-items: flex-start;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">594</strong>            height: calc(100% - 60px);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">595</strong>            width: 100%;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">596</strong>            padding: 16px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">597</strong>            box-sizing: border-box;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">598</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">599</strong>        .half {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">600</strong>            width: calc(50% - 8px);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">601</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">602</strong>        .full {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">603</strong>            width: calc(100% - 8px);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">604</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">605</strong>        .half, .full {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">606</strong>            height: 100%;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">607</strong>            box-sizing: border-box;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">608</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">609</strong>        .render, textarea {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">610</strong>            box-sizing: border-box;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">611</strong>            border: 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">612</strong>            box-shadow: 0 3px 8px -1px rgba(0, 0, 0, .3);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">613</strong>            padding: 12px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">614</strong>            border-radius: 6px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">615</strong>            background: #fff;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">616</strong>            height: 100%;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">617</strong>            -webkit-overflow-scrolling: touch;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">618</strong>            overflow-y: auto;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">619</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">620</strong>        textarea {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">621</strong>            font-family: 'Fira Code', 'Menlo', 'Monaco', monospace;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">622</strong>            width: 100%;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">623</strong>            resize: none;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">624</strong>            font-size: 14px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">625</strong>            outline: none;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">626</strong>            color: #999;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">627</strong>            line-height: 1.5em;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">628</strong>            &#38;:focus {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">629</strong>                color: #000;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">630</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">631</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">632</strong>        .result {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">633</strong>            height: 100%;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">634</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">635</strong>        .render {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">636</strong>            p, pre, code {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">637</strong>                line-height: 1.5em;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">638</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">639</strong>            li {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">640</strong>                margin-bottom: 6px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">641</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">642</strong>            pre {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">643</strong>                padding: 8px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">644</strong>                overflow-x: auto;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">645</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">646</strong>            code {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">647</strong>                padding: 1px 5px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">648</strong>                margin: 0 2px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">649</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">650</strong>            pre, code {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">651</strong>                font-family: 'Menlo', 'Monaco', monospace;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">652</strong>                background: #eee;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">653</strong>                border-radius: 4px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">654</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">655</strong>            q {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">656</strong>                &#38;::before, &#38;::after {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">657</strong>                    content: '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">658</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">659</strong>                display: block;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">660</strong>                border-left: 3px solid #777;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">661</strong>                padding-left: 6px;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">662</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">663</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">664</strong>        `;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">665</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">666</strong></pre></div>
<div class="line"><div class="doc"><p>When the input changes, set the new local state and queue up another render using <code>requestAnimationFrame</code>, to be efficient with when we render (not necessarily now, just before the next frame).</p>
</div><pre class="source javascript"><strong class="lineNumber">671</strong>    handleInput(evt) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">672</strong>        this.inputValue = evt.target.value;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">673</strong>        requestAnimationFrame(() =&#62; this.render());</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">674</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">675</strong></pre></div>
<div class="line"><div class="doc"><p>This is a way to make sure <code>TAB</code> keys can be used to enter four spaces (yay spaces instead of tabs!) instead of tab to the next input on the page. This makes the textarea behave like a text editor, allowing you to indent with tab.</p>
</div><pre class="source javascript"><strong class="lineNumber">680</strong>    handleKeydown(evt) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">681</strong>        if (evt.key === 'Tab') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">682</strong>            evt.preventDefault();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">683</strong>            const idx = evt.target.selectionStart;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">684</strong>            if (idx !== null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">685</strong>                const front = this.inputValue.substr(0, idx);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">686</strong>                const back = this.inputValue.substr(idx);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">687</strong>                this.inputValue = front + '    ' + back;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">688</strong>                this.render();</pre></div>
<div class="line"><div class="doc"><p>Rendering the new input value will make us lose focus on the textarea, so we put the focus back by selecting the area the user was just editing.</p>
</div><pre class="source javascript"><strong class="lineNumber">692</strong>                evt.target.setSelectionRange(idx + 4, idx + 4);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">693</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">694</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">695</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">696</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">697</strong>    handleToggleMode() {</pre></div>
<div class="line"><div class="doc"><p>Increment mode counter to stay within [0, 2] range.</p>
</div><pre class="source javascript"><strong class="lineNumber">699</strong>        this.mode = ++ this.mode % 3;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">700</strong>        this.render();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">701</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">702</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">703</strong>    compose() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">704</strong>        let modeView = null; // unreachable</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">705</strong></pre></div>
<div class="line"><div class="doc"><p>Provide the correct mode view to the app shell depending on the chosen view.</p>
</div><pre class="source javascript"><strong class="lineNumber">708</strong>        switch (this.mode) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">709</strong>            case MODE.EDITOR:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">710</strong>                modeView = jdom`&#60;div class="full result"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">711</strong>                    ${Markus(this.inputValue)}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">712</strong>                &#60;/div&#62;`;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">713</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">714</strong>            case MODE.PREVIEW:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">715</strong>                modeView = jdom`&#60;div class="full markdown"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">716</strong>                    &#60;textarea autofocus value="${this.inputValue}" oninput="${this.handleInput}"</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">717</strong>                        placeholder="Start writing ..." onkeydown="${this.handleKeydown}" /&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">718</strong>                &#60;/div&#62;`;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">719</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">720</strong>            default:</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">721</strong>                modeView = [</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">722</strong>                    jdom`&#60;div class="half result"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">723</strong>                        ${Markus(this.inputValue)}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">724</strong>                    &#60;/div&#62;`,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">725</strong>                    jdom`&#60;div class="half markdown"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">726</strong>                        &#60;textarea autofocus value="${this.inputValue}" oninput="${this.handleInput}"</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">727</strong>                            placeholder="Start writing ..." onkeydown="${this.handleKeydown}" /&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">728</strong>                    &#60;/div&#62;`,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">729</strong>                ];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">730</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">731</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">732</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">733</strong>        return jdom`&#60;main&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">734</strong>            &#60;header&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">735</strong>                &#60;h1 class="title"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">736</strong>                    &#60;span class="dark"&#62;Markus&#60;/span&#62;, a live markdown editor</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">737</strong>                &#60;/h1&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">738</strong>                &#60;div class="buttonGroup"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">739</strong>                    &#60;button class="saveButton" onclick="${this.handleSave}"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">740</strong>                        ${this.showSavedIndicator ? 'saved' : 'save'}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">741</strong>                    &#60;/button&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">742</strong>                    &#60;button class="showRenderedToggle" onclick="${this.handleToggleMode}"&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">743</strong>                        mode ++</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">744</strong>                    &#60;/button&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">745</strong>                &#60;/div&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">746</strong>            &#60;/header&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">747</strong>            &#60;div class="renderContainer"&#62;${modeView}&#60;/div&#62;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">748</strong>        &#60;/main&#62;`;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">749</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">750</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">751</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">752</strong></pre></div>
<div class="line"><div class="doc"><p>Create an instance of the app and mount it to the page DOM.</p>
</div><pre class="source javascript"><strong class="lineNumber">754</strong>const app = new App();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">755</strong>document.body.appendChild(app.node);</pre></div>
<div class="line"><div class="doc"><p>Basic grey background and reset of the default margin on <code>&lt;body&gt;</code></p>
</div><pre class="source javascript"><strong class="lineNumber">757</strong>document.body.style.backgroundColor = '#f8f8f8';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">758</strong>document.body.style.margin = '0';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">759</strong></pre></div>
    </main>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github-gist.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>
        for (const el of document.querySelectorAll('.line pre')) {
            hljs.highlightBlock(el);
        }
    </script>
</body>

</html>
